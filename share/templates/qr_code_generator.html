<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>URL & QR 一括生成（20枠）</title>
<!-- Bootstrap（UI用：ネット接続不要であれば削除可） -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{background:#f8f9fa}
  .qr-box{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .qr-preview{width:120px; height:120px; border:1px solid #dee2e6; background:#fff; display:flex; align-items:center; justify-content:center}
  .url-out{font-size:.9rem; word-break:break-all}
  .row-no{width:2.5rem}
  .sticky-actions{position:sticky; top:0; z-index:10; background:#f8f9fa; padding:.75rem 0}
</style>
</head>
<body>
<div class="container py-4">

  <h1 class="h4 mb-3">URL & QR 一括生成（20枠）</h1>
  <p class="text-muted mb-4">上の「共通URL」と、各行の「パラメータ1 / パラメータ2」を入力して「生成」。URLは <code>?p1=...&amp;p2=...</code> で結合します。PNG保存やZIP一括保存に対応。</p>

  <!-- 設定 -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label">共通URL（例：<code>https://example.com/path</code> または <code>https://example.com/path?x=1</code>）</label>
          <input id="baseUrl" type="text" class="form-control" placeholder="https://example.com/path">
        </div>
      </div>
      <div class="small text-muted mt-2">
        ※ パラメータ名は固定で <code>p1</code> と <code>p2</code> を使用します（変更したい場合はコード内の <code>PARAM1_KEY</code>, <code>PARAM2_KEY</code> を編集）。
      </div>
    </div>
  </div>

  <div class="sticky-actions d-flex gap-2">
    <button id="genAll" class="btn btn-primary">全20件を生成</button>
    <button id="zipAll" class="btn btn-outline-secondary">QRをZIPで一括保存</button>
    <button id="clearAll" class="btn btn-outline-danger">全リセット</button>
  </div>

  <!-- 20行の入力テーブル -->
  <div class="table-responsive">
    <table class="table table-sm align-middle bg-white">
      <thead class="table-light">
        <tr>
          <th class="text-center">#</th>
          <th>パラメータ1</th>
          <th>パラメータ2</th>
          <th>生成URL</th>
          <th>QRプレビュー / 保存</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

</div>

<!-- 依存ライブラリ（CDN） -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-CNgI7xwS7QxXQqg5w8y8mA7a3JfQqC4C3wzqC9s0qj8mA0xq7b6n0H1mN8m7G8U1JXK7vFq2N7Yy9wH14r2zjg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-+yPp3bJ6d2oU7Cdy8w0PzL8wq1Xq+E6i3c1mJb8Jg8uG1pJ5fP3kCwz9p3QO7UQf0Xw1+eX7xWl9mX5h7cK0xw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-bG2yR1e0nJt8l4t8f7e2wO1qXfXhW8+eQj4mGkq0GQxw3l8pQ5bK8a3kP2xGk4lN9w1Q1p6t0x9m7z2H7jM3GQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
(() => {
  // ===== 設定（パラメータ名など） =====
  const ROWS = 20;
  const PARAM1_KEY = 'p1';  // ←必要なら変更
  const PARAM2_KEY = 'p2';  // ←必要なら変更
  const QR_SIZE = 120;      // 120x120 px

  // ===== ユーティリティ =====
  function buildUrl(base, p1, p2){
    if(!base) return '';
    const hasQuery = base.includes('?');
    const sep = hasQuery ? '&' : '?';
    const q = [];
    if(p1 !== '') q.push(`${encodeURIComponent(PARAM1_KEY)}=${encodeURIComponent(p1)}`);
    if(p2 !== '') q.push(`${encodeURIComponent(PARAM2_KEY)}=${encodeURIComponent(p2)}`);
    return q.length ? `${base}${sep}${q.join('&')}` : base;
  }

  function ensureQRCode(container, text){
    container.innerHTML = '';
    if(!text){
      const box = document.createElement('div');
      box.className = 'qr-preview';
      box.textContent = '—';
      container.appendChild(box);
      return null;
    }
    const holder = document.createElement('div');
    holder.className = 'qr-preview';
    container.appendChild(holder);
    const qr = new QRCode(holder, {
      text,
      width: QR_SIZE,
      height: QR_SIZE,
      correctLevel: QRCode.CorrectLevel.M
    });
    return qr;
  }

  function canvasDataURL(container){
    const cvs = container.querySelector('canvas');
    if(!cvs){ return null; }
    return cvs.toDataURL('image/png');
  }

  function downloadDataURL(dataURL, filename){
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // ===== 行の生成 =====
  const tbody = document.getElementById('rows');
  for(let i=1;i<=ROWS;i++){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="text-center row-no">${i}</td>
      <td><input type="text" class="form-control form-control-sm" placeholder="p1 値" data-role="p1"></td>
      <td><input type="text" class="form-control form-control-sm" placeholder="p2 値" data-role="p2"></td>
      <td class="url-out"><div class="small text-muted" data-role="url">—</div></td>
      <td>
        <div class="qr-box">
          <div class="qr-preview" data-role="qr-holder">—</div>
          <div class="d-flex flex-column gap-2">
            <button class="btn btn-sm btn-outline-primary" data-action="gen">生成</button>
            <button class="btn btn-sm btn-outline-secondary" data-action="save">PNG保存</button>
          </div>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }

  // ===== イベント =====
  function handleGenerateRow(tr){
    const idx = tr.rowIndex; // 表示上の行番号ではない点に注意
    const p1 = tr.querySelector('[data-role="p1"]').value.trim();
    const p2 = tr.querySelector('[data-role="p2"]').value.trim();
    const base = document.getElementById('baseUrl').value.trim();

    const url = buildUrl(base, p1, p2);
    tr.querySelector('[data-role="url"]').textContent = url || '—';

    const holder = tr.querySelector('[data-role="qr-holder"]');
    ensureQRCode(holder, url);
  }

  function handleSaveRow(tr){
    const no = tr.querySelector('.row-no').textContent.trim();
    const holder = tr.querySelector('[data-role="qr-holder"]');
    // 未生成なら生成してから保存
    if(holder.textContent === '—'){
      handleGenerateRow(tr);
    }
    const dataURL = canvasDataURL(holder);
    if(!dataURL){
      alert('先に「生成」を押してください。');
      return;
    }
    const urlText = tr.querySelector('[data-role="url"]').textContent.trim();
    const safeName = urlText ? urlText.replace(/[^a-zA-Z0-9._-]/g,'_').slice(0,60) : `row${no}`;
    downloadDataURL(dataURL, `qr_${no}_${safeName}.png`);
  }

  tbody.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action]');
    if(!btn) return;
    const tr = e.target.closest('tr');
    const action = btn.getAttribute('data-action');
    if(action === 'gen') handleGenerateRow(tr);
    if(action === 'save') handleSaveRow(tr);
  });

  // 全件生成
  document.getElementById('genAll').addEventListener('click', () => {
    const trs = Array.from(tbody.querySelectorAll('tr'));
    const base = document.getElementById('baseUrl').value.trim();
    if(!base){
      alert('共通URLを入力してください。');
      return;
    }
    trs.forEach(tr => handleGenerateRow(tr));
  });

  // ZIP 一括保存
  document.getElementById('zipAll').addEventListener('click', async () => {
    const base = document.getElementById('baseUrl').value.trim();
    if(!base){
      alert('共通URLを入力してください。');
      return;
    }
    const trs = Array.from(tbody.querySelectorAll('tr'));
    // 先に全生成
    trs.forEach(tr => handleGenerateRow(tr));

    const zip = new JSZip();
    let added = 0;

    trs.forEach(tr => {
      const no = tr.querySelector('.row-no').textContent.trim();
      const holder = tr.querySelector('[data-role="qr-holder"]');
      const dataURL = canvasDataURL(holder);
      const urlText = tr.querySelector('[data-role="url"]').textContent.trim();
      if(!dataURL || !urlText) return; // 空行はスキップ

      const safeName = urlText.replace(/[^a-zA-Z0-9._-]/g,'_').slice(0,80) || `row${no}`;
      const base64 = dataURL.split(',')[1];
      zip.file(`qr_${no}_${safeName}.png`, base64, {base64:true});
      added++;
    });

    if(added === 0){
      alert('生成済みのQRがありません。パラメータを入力して生成してください。');
      return;
    }

    const blob = await zip.generateAsync({type:'blob'});
    saveAs(blob, 'qr_codes.zip');
  });

  // リセット
  document.getElementById('clearAll').addEventListener('click', () => {
    document.getElementById('baseUrl').value = '';
    Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
      tr.querySelector('[data-role="p1"]').value = '';
      tr.querySelector('[data-role="p2"]').value = '';
      tr.querySelector('[data-role="url"]').textContent = '—';
      const holder = tr.querySelector('[data-role="qr-holder"]');
      holder.innerHTML = '—';
      holder.className = 'qr-preview';
    });
  });

})();
</script>
</body>
</html>
